<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trello to PDF</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.1.0/mustache.min.js"
      type="text/javascript"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.8.2/marked.min.js"
      type="text/javascript"
    ></script>
    <style>
      main {
        min-width: 100vw;
        min-height: 100vh;
        margin: 0 auto;
      }

      div#upload {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      div#drop-zone {
        z-index: 10;
        position: fixed;
        width: 100vw;
        height: 100vh;
        background-color: #026aa7;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.1s;
        transition-delay: 0.05s;
        pointer-events: none;
      }

      div#drop-zone.visible {
        opacity: 1;
      }

      h1 {
        margin-top: 1em;
        text-align: center;
      }

      h3 {
        margin: 0em 0 1.5em 0;
      }

      h6.divider {
        margin-top: 2em;
        text-align: center;
        font-weight: 600;
      }

      blockquote {
        margin-left: 1em;
        padding-left: 1em;
        border-left: 3px solid var(--gray) !important;
        color: var(--gray);
      }

      time {
        font-size: 0.8em;
        color: var(--gray);
      }

      ul.comments {
        margin: 0;
        padding: 0 1em;
        list-style: none;
      }

      ul.comments > li {
        padding-left: 1em;
        border-left: 3px solid black;
      }

      section {
        margin: 0 auto;
        max-width: 800px;
      }

      section.selector {
        padding: 2em 0;
        width: max-content;
      }
    </style>
    <style type="text/css" media="print">
      section.selector {
        display: none;
      }
      blockquote {
        border: 0;
      }
    </style>
  </head>

  <body>
    <div id="drop-zone">
      <h1>Drop!</h1>
    </div>
    <main>
      <div id="upload">
        <h2 style="margin-bottom: 1em">Trello to PDF</h2>
        <h6>Drop a JSON File Here:</h6>
        <div class="custom-file" style="max-width: 400px; margin: 0.5em 0">
          <input type="file" class="custom-file-input" id="customFile" />
          <label class="custom-file-label" for="customFile">Choose file</label>
        </div>
        <p style="color: var(--gray)"><small>(don't worry, we don't upload anything)</small></p>
        <p style="color: var(--gray); position: fixed; bottom: 1em">
          <small>
            version 1.1.0
            <a href="https://github.com/arlyon/trello-to-pdf" style="color: inherit; text-decoration: underline"
              >source</a
            >
          </small>
        </p>
      </div>
    </main>

    <script type="text/html" id="template-output">
      <section class="selector">
        <h5>Display Lists</h5>
        {{#lists}}
        <input
          type="checkbox"
          title="{{name}}"
          checked="checked"
          onclick="(input => document.getElementById(`{{name}}`).hidden = !input.checked)(this)"
        />
        {{/lists}}
      </section>

      {{#lists}}
      <section id="{{name}}">
        <h1>{{name}}</h1>
        {{#cards}}
        <div class="card-body">
          <h3 class="card-title">{{name}}</h3>
          {{#desc}}{{{desc}}}{{/desc}} {{^desc}}<span style="color: var(--gray)">No Description</span>{{/desc}}
          {{#actions.length}}
          <h6 class="divider">COMMENTS</h6>
          <ul class="comments">
            {{#actions}}
            <li>
              <span style="font-weight:600">{{author}} </span><time datetime="{{date}}">{{date}}</time>
              {{{text}}}
            </li>
            {{/actions}} {{/actions.length}}
          </ul>
        </div>
        {{/cards}}
      </section>
      {{/lists}}
    </script>
    <script type="text/javascript">
      const eatData = (trelloJson) => {
        const data = {
          board: trelloJson.name,
          lists: [],
          ref: {},
        };

        for (list of trelloJson.lists) {
          if (list.closed) {
            continue;
          }
          data.ref[list.id] = {
            name: list.name,
            cards: [],
          };
          data.lists.push(data.ref[list.id]);
        }

        for (card of trelloJson.cards) {
          if (card.closed) {
            continue;
          }

          data.ref[card.id] = {
            name: card.name,
            desc: marked(card.desc),
            actions: [],
          };

          data.ref[card.idList].cards.push(data.ref[card.id]);
        }

        for (action of trelloJson.actions) {
          if (action.type != "commentCard") {
            continue;
          }
          data.ref[action.id] = {
            text: marked(action.data.text),
            date: action.date.split("T")[0],
            author: action.memberCreator.fullName,
            username: action.memberCreator.username,
          };
          try {
            data.ref[action.data.card.id].actions.unshift(data.ref[action.id]);
          } catch (e) {}
        }

        return data;
      };

      const showData = (data) => {
        var template = document.getElementById("template-output").innerHTML;
        root.innerHTML = Mustache.render(template, data);
      };

      const root = document.getElementsByTagName("main")[0];
      const fileUpload = document.getElementById("customFile");
      const dropZone = document.getElementById("drop-zone");

      const loadFile = (event) => {
        let files;
        if (event.type === "change") {
          files = fileUpload.files;
        } else if (event.type === "drop") {
          files = event.dataTransfer.files;
        }

        const file = files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              json = JSON.parse(reader.result);
            } catch {
              return alert("Invalid JSON");
            }
            try {
              parsed = eatData(JSON.parse(reader.result));
            } catch {
              return alert("Not a valid Trello File");
            }
            document.title = parsed.board;
            showData(parsed);
          };
          reader.readAsText(file);
        }

        dropZone.className = "";
        event.preventDefault();
      };

      root.ondrop = loadFile;
      fileUpload.onchange = loadFile;
      root.ondragover = (event) => event.preventDefault();
      root.ondragenter = () => (dropZone.className = "visible");
      root.ondragexit = () => (dropZone.className = "");
    </script>
  </body>
</html>
