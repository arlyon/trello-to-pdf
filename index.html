<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Trello Printer</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <style>
      #root {
        min-width: 100vw;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      #drop-zone {
        z-index: 10; 
        position: absolute; 
        width: 100vw; 
        height: 100vh; 
        background-color: #026aa7; 
        color: white; 
        display: flex; 
        justify-content: center; 
        align-items: center;
        opacity: 0;
        transition: opacity ease-in-out;
        pointer-events: none;
      }
      #drop-zone.visible {
          opacity: 1;
      }

      h1 {
        text-align: center;
      }

      section {
        max-width: 800px;
      }

      .comments {
        margin: 0;
        padding-left: 1.5em;
        list-style: none;
      }

      .comments > li {
        padding-left: 1em;
        border-left: 3px solid black;
      }

      div.selector {
        margin: 2em;
      }
    </style>
    <style type="text/css" media="print">
      div.selector {
        display: none;
      }
      section {
        max-width: inherit;
      }
    </style>

    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"
      type="text/javascript"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"
      type="text/javascript"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.0/marked.min.js"
      type="text/javascript"
    ></script>
  </head>

  <body>
    <div id="root">
        <div id="drop-zone">
            <h1>Drop!</h1>
        </div>
      <h2 style="margin-bottom: 1em;">Trello to PDF</h2>
      <h6>Drop a JSON File Here:</h6>
      <div class="custom-file" style="max-width: 400px; margin: 0.5em 0">
        <input type="file" class="custom-file-input" id="customFile" />
        <label class="custom-file-label" for="customFile">Choose file</label>
      </div>
      <p style="opacity: 0.4;"><small>(don't worry, we don't upload anything)</small></p>
    </div>

    <script type="text/html" id="template-output">
      <div class="selector">
          <h5>Display Lists</h5>
          {{#lists}}
      <input type="checkbox" title="{{name}}" checked="checked" onclick='(input => document.getElementById(`{{name}}`).hidden = !input.checked)(this)' />
          {{/lists}}
      </div>

      {{#lists}}
          <section id="{{name}}">
              <h1>{{name}}</h1>
              {{#cards}}
                  <div class="">
                      <div class="card-body">
                          <h4 class="card-title">{{name}}</h5>
                          {{{desc}}}
                      </div>
                      <ul class="comments">
                      {{#actions}}
                          <li class=""><tt style="color:gray;">{{date}}</tt>{{{text}}}</li>
                      {{/actions}}
                      </ul>
                  </div>
              {{/cards}}
          </section>
      {{/lists}}
    </script>
    <script type="text/javascript">
      function eatData(trelloJson) {
        const data = {
          board: trelloJson.name,
          lists: [],
          ref: {}
        };

        for (list of trelloJson.lists) {
          if (list.closed) {
            continue;
          }
          data.ref[list.id] = {
            name: list.name,
            cards: []
          };
          data.lists.push(data.ref[list.id]);
        }

        for (card of trelloJson.cards) {
          if (card.closed) {
            continue;
          }

          data.ref[card.id] = {
            name: card.name,
            desc: marked(card.desc),
            actions: []
          };

          data.ref[card.idList].cards.push(data.ref[card.id]);
        }

        for (action of trelloJson.actions) {
          if (action.type != "commentCard") {
            continue;
          }

          data.ref[action.id] = {
            text: marked(action.data.text),
            date: moment(action.date).format("YYYY-MM-DD")
          };
          try {
            data.ref[action.data.card.id].actions.unshift(data.ref[action.id]);
          } catch (e) {}
        }

        return data;
      }

      const root = document.getElementById("root")
      const fileUpload = document.getElementById("customFile")
      const dropZone = document.getElementById("drop-zone")
      
      function showData(data) {
        var template = document.getElementById("template-output").innerHTML;
        root.innerHTML = Mustache.render(template, data);
      }

      const loadFile = (event) => {

        let files;
        if (event.type === 'change') {
            files = fileUpload.files
        } else if (event.type === 'drop') {
            files =  event.dataTransfer.files
        }

        const file = files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    json = JSON.parse(reader.result)
                } catch {
                    return alert("Invalid JSON")
                }
                try {
                    parsed = eatData(JSON.parse(reader.result));
                } catch {
                    return alert("Not a valid Trello File")
                }
                document.title = parsed.board;
                showData(parsed);
            }
            reader.readAsText(file)
        }

        dropZone.className = ""
        event.preventDefault()
      }
      
      root.ondrop = loadFile
      fileUpload.onchange = loadFile;
      root.ondragover = (event) => event.preventDefault();
      root.ondragenter = () => dropZone.className = "visible"
      root.ondragexit = () => dropZone.className = ""
    </script>
  </body>
</html>
